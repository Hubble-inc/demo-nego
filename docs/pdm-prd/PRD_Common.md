# HubbleNego 共通仕様書

> このドキュメントは、Nego単体利用・Hubble連携利用の両方に共通する仕様を定義します。
> - Nego単体利用の詳細 → [PRD_Nego_Standalone.md](./PRD_Nego_Standalone.md)
> - Hubble連携利用の詳細 → [PRD_Nego_Hubble.md](./PRD_Nego_Hubble.md)

---

## 1. プロダクト概要

### 1.1 プロダクトビジョン
> **「契約がわかると、信頼される。」**

AIが契約書を「あなたの言葉」に翻訳し、理解して交渉し、守れる約束を結ぶ。それが次のビジネスを生む。

### 1.2 解決する課題

| 課題 | 現状 | HubbleNegoによる解決 |
|------|------|----------------------|
| 契約書が難しい | 法律用語が理解できず、何を約束しているのかわからない | AIが平易な日本語に翻訳、要点を3行でサマリー |
| 交渉に時間がかかる | メールの往復で認識のズレが発生、締結まで長期化 | 同じ画面でリアルタイム交渉、コメント・チャットで即解決 |
| 版管理が混乱 | 「最新版どれ？」問題、変更履歴が追えない | 自動バージョン管理、差分比較機能 |

### 1.3 ターゲットユーザー

#### プライマリペルソナ
**「契約書を扱う必要があるが、法務の専門家ではないビジネスパーソン」**

- 営業マネージャー（取引先との契約交渉）
- 事業開発担当者（パートナーシップ契約）
- スタートアップ経営者（各種契約を自分で対応）
- フリーランス・個人事業主（業務委託契約）
- 財務担当者（投資契約など重要な契約の交渉・締結）

#### セカンダリペルソナ
- 法務担当者（複数の契約を効率的に管理）

---

## 2. AI機能

### 2.0 AI機能のフェーズ分け

AI機能は精度と信頼性を優先し、2フェーズに分けてリリースする。

| フェーズ | 機能 | 理由 |
|---------|------|------|
| MVP | 要点サマリー（3行） | コアバリュー「契約書が読める」の入口 |
| MVP | テキスト選択 → AI解説 | ユーザーが能動的に「わからない」を解消する体験 |
| MVP | ハイライト（金額・期間・責任範囲） | 受動的に重要箇所が目に入る。サマリーと相乗効果 |
| Phase 2 | AIチャット（自由質問） | MVPのサマリー+解説で足りないケースへの対応 |
| Phase 2 | タイムライン抽出 | 精度要件が高い（日付の誤抽出は致命的） |
| Phase 2 | 人・モノ・金の流れ図 | 可視化の品質担保に時間がかかる |
| Phase 2 | リスク分析 / レビュー | 法的判断に関わるため、精度検証を十分に行ってからリリース |
| Phase 2 | `/`コマンド（レビュー / リスク分析 / 変更点確認 / 詳しく解説） | AIチャットと同時リリース |

- AI機能が利用不可の場合のフォールバック: AI生成欄に「生成中にエラーが発生しました。[再生成]」ボタンを表示。契約書の閲覧・交渉機能はAIに依存せず単独で動作する設計を維持
- 精度要件: MVPの3機能は「おおむね正しい（90%以上）」を目標。Phase 2のリスク分析は「間違えてはならない」レベルを目標とし、それまでリリースしない
- MVP の AI分析カード: サマリー + 一般契約との違いのみ表示。人モノ金の流れ図とタイムラインは Phase 2 まで非表示（空欄やプレースホルダーは置かない）
- MVP の AIタブ: ウェルカム画面のクイックアクションは「詳しく解説」のみ残し、他3つ（レビュー / リスク分析 / 変更点確認）は Phase 2 まで非表示

### 2.1 契約書サマリー（自動生成）

| 機能 | 説明 |
|------|------|
| 要点サマリー | 契約の要点を3行で自動生成 |
| 人・モノ・金の流れ | 当事者間の取引構造を図示 |
| タイムライン | 重要日付（開始・満了・更新判断期限・請求日等）を自動抽出 |
| ハイライト | 金額・期間・責任範囲を自動でマーク |

### 2.2 AI解説機能

| 機能 | 説明 |
|------|------|
| テキスト選択解説 | 選択した条文をAIタブにチャット形式でインライン解説（§2.4 AIチャットタブに表示） |
| 注意点の提示 | リスクや注意すべきポイントをアラート表示 |
| 質問応答 | 契約内容についてAIチャットタブで自由に質問可能（§2.4） |

### 2.3 AI生成物の表示ルール
- 全てのAI生成コンテンツに「AI生成」バッジを表示
- 「契約書から自動生成されています。内容をご確認ください。」の注記

### 2.4 AIチャットタブ

右サイドバーのAIタブに常設されるチャット形式のAIアシスタント。契約書の内容について対話的に質問・分析できる。

| 項目 | 仕様 |
|------|------|
| 表示場所 | 右サイドバーのAIタブ（§9.3） |
| チャット形式 | ユーザーメッセージとAIアシスタントメッセージの対話形式 |
| ウェルカム画面 | 初回表示時に「今日は何から始めますか？」とクイックアクションボタンを提示 |
| クイックアクション | レビュー / リスク分析 / 変更点確認 / 詳しく解説 の4種類 |
| `/`コマンド | テキスト入力欄で `/` を入力するとコマンドパレットが表示され、クイックアクションを選択可能 |
| テキスト選択連携 | 契約書本文のテキスト選択 →「AIで解説」でAIタブに切替、選択テキストをユーザーメッセージとして送信しAI応答を表示 |
| 免責表示 | 入力欄下に「AIは不正確な情報を生成する可能性があります。回答は必ずご確認ください。」を常時表示 |

---

## 3. リアルタイム交渉機能

### 3.1 メッセージ（チャット）

| 項目 | 仕様 |
|------|------|
| リアルタイム送受信 | 対応 |
| 送信者表示 | アバター（イニシャル）＋名前＋タイムスタンプ |
| 既読機能 | 将来対応 |
| 通知 | メール通知（新着メッセージ時） |

### 3.2 コメント（引用ブロック方式）

コメント機能はメッセージ（チャット）と統合されており、契約書のテキストを「引用ブロック」としてメッセージに添付する形式で実現する。

> **設計意図**: このコメントフロー（テキスト選択 → 引用ブロック → メッセージ送信）は、Hubbleの現行コメント仕様と同一のUXを採用している。Hubble連携ユーザーが違和感なく利用できるよう、操作体験の一貫性を保つ設計。

| 項目 | 仕様 |
|------|------|
| 対象 | 契約書内の任意のテキストに紐付け |
| コメント追加フロー | テキスト選択 → ポップアップ「コメント」 → チャットタブに切替＋引用ブロックに選択テキストがセットされ、メッセージ入力にフォーカス |
| コメントインジケーター | 契約書本文にコメントアイコン＋件数を表示。クリックでチャットタブに切替＋該当テキストを引用ブロックにセット |
| 引用ブロック表示 | メッセージ入力欄の上部に、引用元テキストをハイライト表示。×ボタンで引用を解除可能 |
| 送信時の表示 | 引用ブロック付きメッセージとして送信され、メッセージ一覧に引用テキスト＋コメント本文が表示される |

---

## 4. バージョン管理

### 4.1 自動バージョニング

| 項目 | 仕様 |
|------|------|
| バージョン作成タイミング | ファイルアップロード時に自動作成 |
| 表示情報 | バージョン番号、編集者名、日時、変更概要 |
| 初版・最新の表示 | バッジで明示 |

### 4.2 当事者バッジ

バージョン履歴の各アイテムには、どちらの当事者がアップロードしたかを示すバッジを表示する。

| バッジ | スタイル | 説明 |
|--------|---------|------|
| 自社 | 青系（`internal`） | 自分側がアップロードしたバージョン |
| 先方 | オレンジ系（`external`） | 交渉相手がアップロードしたバージョン |

- バッジはバージョン番号・編集者名・日時と同じ行に表示
- どちらの修正版かが一目でわかることで、交渉の流れを把握しやすくする

### 4.3 バージョン比較

| 項目 | 仕様 |
|------|------|
| MVP | バージョン履歴から任意のバージョンをダウンロードし、Wordの「校閲 → 比較」機能で差分確認する運用を推奨 |
| Phase 2 | AIチャット（§2.4）で「v2とv3で何が変わった？」と質問すると、自然言語で差分を解説（例:「第4条の報酬額が月額10万円→12万円に増額」） |

> **設計意図**: 法務担当者はWordの比較機能に習熟している。Nego内に差分ビューアを構築するよりも、AIによる「差分の意味の解説」に開発リソースを集中する方がユーザー価値が高い。

### 4.4 Wordファイル編集連携

| 項目 | 仕様 |
|------|------|
| ダウンロード | 現在のバージョンをWordでダウンロード |
| アップロード | 編集済みWordをアップロードして新バージョン作成 |
| 差分確認 | アップロード時に変更内容をプレビュー |

---

## 5. 署名・締結フロー

### 5.1 全体フロー

```
[交渉完了] → [署名手続き・設定] → [署名依頼送信] → [全員署名完了] → [契約締結]
                  │                     │                 │              │
                  ↓                     ↓                 ↓              ↓
           書類選択・            各署名者に          ステータス      紙吹雪演出で
           署名者設定・          署名画面を送信      バナーで進捗    締結を祝福
           署名位置配置                              を表示

```

### 5.2 署名手続き・設定ウィザード（3ステップ）

交渉画面のヘッダーにある「署名手続き・設定」ボタンから起動する。

**ステッパーラベル**: 「書類選択」→「署名者追加」→「署名位置」

#### Step 1: 書類の選択

署名対象の書類を選択する。契約書タブに登録されている書類が一覧表示される。

| 項目 | 仕様 |
|------|------|
| 書類タイプ: 契約書 | デフォルトで **チェックON** |
| 書類タイプ: 添付書類 | デフォルトで **チェックOFF** |
| AI要約表示 | 選択中の契約書のAI要約を右側に表示 |
| 複数書類対応 | 複数の契約書・添付書類をパッケージとして署名可能 |

#### Step 2: 署名者の設定

署名に参加する当事者を設定する。

| 項目 | 仕様 |
|------|------|
| 署名者の識別 | 名前・会社名・色分けで識別（ラベルは使用しない） |
| 署名者タイプ | 「自分で署名」または「相手に送信」 |
| 署名者の追加 | 3者以上のマルチサイナーに対応 |
| 署名方法の選択 | 署名者ごとにテキスト署名 or 印影を選択 |
| メールアドレス | 「相手に送信」の場合に入力 |
| 転送許可 | 受信者が別の署名者に転送できるオプション（デフォルト: ON） |
| 署名順序 | 順次署名（リレー方式）または 一括送信（並行方式）を選択 |

#### Step 3: 署名位置の配置と実行

| 項目 | 仕様 |
|------|------|
| 署名位置の配置 | 契約書プレビュー上にドラッグ&ドロップで署名位置を指定 |
| 配置の必須/任意 | **任意**。印影の配置は必須ではなく、配置しなくても署名手続きを完了できる。署名者側でも位置選択は不要 |
| 署名者ごとの色分け | 各署名者に割り当てられた色でスタンプ位置を表示 |
| 書類ごとの配置 | 複数書類がある場合、書類タブを切り替えて各書類に配置 |
| 自分の署名 | 「自分で署名」の署名者は、ここで署名入力＋同意チェック |
| 実行ボタン | 全ての必須項目（自分の署名入力＋同意チェック）完了後に活性化 |

### 5.3 署名方法

| 方法 | 説明 |
|------|------|
| テキスト署名 | 名前をテキスト入力し、署名スタイルでプレビュー表示 |
| 印影（デジタル印鑑） | 姓を入力し、丸い印影スタイルでプレビュー表示 |

### 5.4 署名画面（sign.html）

署名依頼を受けた相手に表示される独立した署名専用画面。

| 項目 | 仕様 |
|------|------|
| 依頼者情報・メッセージ | 署名依頼者の名前・会社名、および依頼メッセージを表示 |
| 契約書プレビュー | A4サイズのプレビュー表示、全文展開可能 |
| 契約書ダウンロード | PDF形式でダウンロード可能（捺印前の社内回覧用途を想定） |
| AI要約 | 契約の要点サマリーを表示 |
| 署名入力 | 指定された方法（テキスト or 印影）で署名 |
| 同意チェック | 「内容を確認し、同意します」チェックボックス |
| 完了演出 | 署名完了時に紙吹雪演出 |
| 転送機能 | 転送許可されている場合、別の署名者への転送が可能。詳細は§5.4.2を参照 |
| 辞退機能 | 署名を辞退する機能。理由入力（必須）付き。詳細は§5.9を参照 |

#### 5.4.1 モバイル署名体験

署名依頼はメールで届くため、受信者がスマートフォンで開く可能性が極めて高い。sign.html はモバイルファーストで設計する。

| 項目 | 仕様 |
|------|------|
| レイアウト | 縦スクロール1カラム |
| 契約書プレビュー | AI要約を最初に表示。「契約書の全文を確認」をタップで展開（横スワイプページ送りUI） |
| 署名入力 | ボトムシートとして画面下部にスティッキー表示。契約書をスクロールしても常に署名欄が見える |
| タッチターゲット | 全タップ可能要素は最低44x44px |
| PDFダウンロード | 全文展開エリアの上に配置 |

#### 5.4.2 署名転送

署名者が別の担当者に署名を委任する機能。転送は「署名義務からの離脱」を意味する。

| 項目 | 仕様 |
|------|------|
| 起動方法 | sign.html の「ほかの方に転送」ボタン |
| 入力項目 | 転送先の名前・メールアドレス（必須）、転送理由（任意） |
| 警告表示 | 「転送すると、あなたはこの契約の署名者ではなくなります」をモーダルに常時表示 |
| 転送元の状態 | 署名対象から除外。sign.html の署名リンクは無効化 |
| 転送先の状態 | 新しい署名リンクが発行され、署名依頼メールが送信される |
| 通知 | 署名依頼の送信者（交渉メンバー）に「○○さんが△△さんに署名を転送しました」メール通知 |
| チェーン転送 | 転送先からさらに転送を許可。ただし最大3回まで。超過時は「依頼者にお問い合わせください」と表示 |
| 転送のキャンセル | 転送元は転送をキャンセルできない。必要な場合は署名依頼の取り消し（§5.10）で対応 |
| 監査ログ | 転送操作を記録（転送元、転送先、日時、理由） |

### 5.5 ステータス管理

ステータスは「契約ステータス」と「ユーザーロール」の2軸で管理する。
画面のバナー表示やボタン状態は、この2軸の組み合わせで決定される。

#### 契約ステータス（契約に1つ。ライフサイクルの進行状態）

| ステータス | 英名 | 説明 | グローバルバナー |
|-----------|------|------|----------------|
| 交渉中 | negotiating | 契約内容を協議中 | バナーなし |
| 署名手続き済み | signing_setup_done | 署名手続きが完了し、署名依頼を送信した状態 | 「署名依頼を送信しました」 |
| 自分署名済み | my_signer_signed | 自分側の署名が完了、相手の署名待ち | 「相手方の署名を待っています」 |
| 締結済み | concluded | 全署名者の署名が完了し契約締結 | 「契約が締結されました」 |
| 中断 | suspended | 交渉が途中で中止された状態。いつでも再開可能 | 「この交渉は中断されています」 |

#### ユーザーロール（画面を見ている人の立場。表示制御に使用）

| ロール | 英名 | 説明 | ヘッダーボタン表示 |
|--------|------|------|-------------------|
| 交渉メンバー | member | 交渉に参加し、編集・コメント・署名手続き設定を行う | 「署名手続き・設定」 |
| 署名者 | signer | 署名依頼を受け、署名を行う | 「署名ページを開く」 |

#### ロールとステータスの組み合わせによるバナー表示

| ロール | 契約ステータス | バナー表示 |
|--------|-------------|-----------|
| member | signing_setup_done | 「署名依頼を送信しました」 |
| signer | signing_setup_done | 「契約書の署名をお願いします」 |
| signer | my_signer_signed | 「相手方の署名を待っています」 |
| （共通） | concluded | 「契約が締結されました」 |
| （共通） | suspended | 「この交渉は中断されています」 |

### 5.6 締結済みビューア

全員の署名が完了した後に表示される専用画面。

| 項目 | 仕様 |
|------|------|
| 表示形式 | フルスクリーンビューア |
| 書類タブ | 複数書類がある場合、タブで切り替え表示 |
| 署名記録 | 全署名者の署名内容・タイムスタンプを一覧表示 |
| AI要約 | 契約の要点サマリーを再表示 |
| 署名証明書 | 証明書リンクを表示 |
| ダウンロード | 個別PDF / 一括PDFダウンロード |
| 編集ロック | 締結後は契約書の編集不可 |

### 5.7 締結後のアクション
- 契約書のPDFダウンロード（個別 / 一括）
- 署名証明書の確認
- 契約書の編集ロック

### 5.8 交渉の中断

交渉が途中で終了した場合に、交渉を「中断」ステータスに変更する機能。

#### 中断の操作

| 項目 | 仕様 |
|------|------|
| 起動方法 | ヘッダーの「...」（その他メニュー）ボタン → 「この交渉を中断する」 |
| 確認ダイアログ | 中断理由を入力するモーダルを表示 |
| 理由の入力 | テキストエリア（任意入力）。後から確認できるよう保存される |
| 操作権限 | 交渉メンバー（member）のみ実行可能 |

#### 中断後の状態

| 項目 | 仕様 |
|------|------|
| グローバルバナー | グレー系で「この交渉は中断されています」＋中断理由を表示 |
| ヘッダーボタン | 「署名手続き・設定」が非活性化。代わりに「交渉を再開する」ボタンを表示 |
| 編集制限 | 契約書のアップロード・コメントは不可。閲覧のみ |
| 再開 | 「交渉を再開する」ボタンでいつでも交渉中（negotiating）に復帰可能 |

#### 通知

| 項目 | 仕様 |
|------|------|
| 中断時 | 他の交渉メンバー全員にメール通知（中断理由を含む） |
| 再開時 | 他の交渉メンバー全員にメール通知 |

### 5.9 署名の辞退（sign.html）

署名依頼を受けた署名者が、署名を辞退する機能。

#### 辞退の操作

| 項目 | 仕様 |
|------|------|
| 起動方法 | 署名画面の「署名を確定する」ボタン下に「署名を辞退する」テキストリンク |
| 辞退理由の入力 | モーダルで理由を入力（必須）。プリセット選択肢＋自由記述 |
| プリセット選択肢 | 「契約内容に修正が必要」「社内承認が得られなかった」「担当者が変更になった」「その他」 |
| 完了画面 | 辞退完了画面を表示（「署名を辞退しました」＋交渉画面への導線） |

#### 辞退後の影響

| 項目 | 仕様 |
|------|------|
| 交渉ステータス | 交渉中（negotiating）に戻る。署名手続きはリセットされる |
| 通知 | 署名依頼の送信者（交渉メンバー）全員にメール通知（辞退理由を含む） |
| 交渉画面のバナー | 「○○様が署名を辞退しました」バナーを表示（理由を含む） |

### 5.10 署名依頼の取り消し

署名依頼を送信した後に、送信側（交渉メンバー）がその依頼を取り消す機能。「中断」（§5.8）が交渉全体を凍結するのに対し、取り消しは署名手続きだけを巻き戻し、交渉を即座にアクティブに戻す。

#### 取り消し可能な範囲

| ステータス | 取り消し可否 | 既存の署名の扱い |
|-----------|------------|---------------|
| `signing_setup_done`（誰もまだ署名していない） | 可能 | — |
| `my_signer_signed`（一部署名済み） | 可能 | 既存の署名は無効化される（署名記録は監査ログに残るが、契約の効力なし） |
| `concluded`（締結済み） | 不可 | 締結は不可逆 |

#### 操作フロー

| 項目 | 仕様 |
|------|------|
| 起動方法 | 署名依頼送信後のバナーに「署名依頼を取り消す」リンクを直接配置 |
| 確認モーダル | 取り消し理由のラジオボタン（契約内容に修正が必要 / 署名者の変更が必要 / 誤って送信した / その他）＋自由記述テキストエリア |
| 署名済み警告 | `my_signer_signed` の場合、「○○さんは署名済みですが、取り消すとこの署名は無効になります。」を確認モーダルに表示 |
| 実行ボタン | 「取り消しを確定」（destructive style） |

#### 取り消し後の状態

| 項目 | 仕様 |
|------|------|
| ステータス | `negotiating` に復帰 |
| 署名リンク | 全ての未署名リンクが無効化。アクセスすると「この署名依頼は取り消されました」画面を表示 |
| 既存署名 | 無効化（署名記録は監査ログに残るが、契約の効力なし） |
| 交渉機能 | 編集・コメント・バージョンアップロードが再有効化 |
| バナー | 「署名依頼を取り消しました。交渉を続けられます。」を一時表示 |

#### 通知

| 項目 | 仕様 |
|------|------|
| 署名者宛 | 全署名者にメール通知:「署名依頼が取り消されました」＋取り消し理由 |
| メンバー宛 | 交渉メンバー全員にメール通知 |

#### 監査ログ
「署名依頼の取り消し」を操作ログの記録対象に追加（操作者、日時、理由、無効化された署名の一覧）。

### 5.11 監査証跡・署名証明書

契約プロダクトにおいて法的信頼性の根幹となる監査証跡と署名証明書の仕様。

#### 操作ログの記録項目

| 項目 | 仕様 |
|------|------|
| 記録対象 | バージョンアップロード、メッセージ送信、署名実行、署名辞退、署名依頼の取り消し、交渉中断/再開、メンバー追加/削除、署名転送、署名手続き設定変更 |
| 記録項目 | 操作者（名前＋メールアドレス）、操作内容、タイムスタンプ（UTC）、IPアドレス、ユーザーエージェント |
| 閲覧UI | 交渉詳細画面のヘッダー「...」メニュー → 「操作履歴」。時系列リストで表示。交渉メンバーのみ閲覧可能 |
| 保持期間 | 締結後10年間（電子署名法の保存義務に準拠） |

#### 署名証明書の記載内容

| 項目 | 内容 |
|------|------|
| 文書情報 | 契約書名、文書ハッシュ値（SHA-256）、ページ数 |
| 署名者情報 | 全署名者の名前、メールアドレス、署名日時、IPアドレス、認証方式（Google OAuth / Microsoft OAuth） |
| 署名方法 | テキスト署名 or 印影の区分 |
| タイムライン | 署名依頼日時 → 各署名者の署名日時 → 締結日時を時系列表示 |
| 改ざん検知 | 締結時に文書のSHA-256ハッシュを記録。証明書にハッシュ値を記載し、ダウンロードしたPDFとの照合を可能にする |
| フォーマット | PDF（A4 1-2ページ）。締結済みビューア（§5.6）からダウンロード可能 |

---

## 6. 期日・タイムライン管理

### 6.1 自動抽出される日付

| 日付タイプ | 説明 |
|-----------|------|
| 契約開始日 | 契約の効力発生日 |
| 契約満了日 | 契約の終了日 |
| 更新判断期限 | 自動更新を止めるための通知期限 |
| 請求書発行日 | 月次等の請求日 |
| 支払期日 | 報酬の支払い期限 |

### 6.2 タイムライン表示
- 時系列でイベントを一覧表示
- 完了/今月/毎月/重要などのバッジ表示
- カウントダウン表示（更新判断期限まで「あとX日」）

### 6.3 チャット欄のタイムライン設計

右サイドバーのチャットタブは「人の会話」と「システムの事実記録」が混在する場所になる。この2つを視覚的に明確に分離する。

#### メッセージバブル（人の発言）

| 項目 | 仕様 |
|------|------|
| 表示形式 | アバター + 名前 + バブル（左寄せ） |
| フォント | 通常サイズ |
| 引用ブロック | §3.2 に準拠。引用テキストはバブル上部にハイライト表示 |

#### イベント行（システムの事実記録）

| 項目 | 仕様 |
|------|------|
| 表示形式 | 区切り線 + テキスト（中央寄せ、小フォント、`color-text-tertiary`） |
| アバター | 表示しない |
| タイムスタンプ | イベントテキストの末尾に `HH:MM` で表示 |

#### イベント行として表示する操作一覧

| イベント | 表示テキスト例 |
|---------|-------------|
| メンバー招待 | 「田中太郎さんが山田花子さんを招待しました」 |
| メンバー参加 | 「山田花子さんが交渉に参加しました」 |
| バージョンアップロード | 「田中太郎さんが新しいバージョン（Ver.3）をアップロードしました」 |
| 署名手続き開始 | 「署名手続きが開始されました」 |
| 署名依頼送信 | 「山田花子さんに署名依頼が送信されました」 |
| 署名完了 | 「山田花子さんが署名しました」 |
| 署名辞退 | 「山田花子さんが署名を辞退しました」 |
| 署名依頼取り消し | 「田中太郎さんが署名依頼を取り消しました」 |
| 署名転送 | 「山田花子さんが鈴木一郎さんに署名を転送しました」 |
| 交渉中断 | 「田中太郎さんがこの交渉を中断しました」 |
| 交渉再開 | 「田中太郎さんがこの交渉を再開しました」 |

> イベント行はクリック不可。チャットログのエクスポート（§15）時には、メッセージとイベントの両方が時系列順に含まれる。

---

## 7. 通知設計

### 7.1 設計思想

| 原則 | 説明 |
|------|------|
| ズボラな人向け | デフォルト設定のまま何もしなくても適切な通知が届く |
| 通知疲れ防止 | 同一人物の連続アクションをまとめて1通にするなど、通知数を最小化 |
| 受け手の状態に合わせる | 未登録ユーザー・登録ユーザー・Hubble連携ユーザーで通知内容と導線を最適化 |

### 7.2 ユーザータイプ別の通知対象

通知の受け手は3タイプ存在する。それぞれ受け取る通知の範囲と導線が異なる。

#### タイプA: Negoユーザー（Hubble未連携）

Negoに登録済みのユーザー。交渉の主体として全ての通知を受け取る。

#### タイプB: 未サインアップの招待ユーザー

Negoユーザーに招待されたが、まだサインアップしていないユーザー。メール通知のみ受け取り、通知の導線はすべて招待受領画面（invite.html）やサインアップへ誘導する。

#### タイプC: Hubble連携ユーザー

HubbleとNegoを連携しているユーザー。基本的にはタイプAと同じ通知を受け取るが、Hubble側の通知（社内コメント等）と重複しないよう調整する。

---

### 7.3 通知イベント一覧

交渉のライフサイクルに沿って、全通知イベントを定義する。

#### 交渉フェーズの通知

| イベント | トリガー | タイプA | タイプB | タイプC | 優先度 | 配信タイミング |
|---------|---------|:------:|:------:|:------:|-------|------------|
| 交渉への招待 | メンバーが招待された時 | ✅ | ✅ | ✅ | 高 | 即時 |
| 新しいメッセージ | チャットで相手がメッセージ送信 | ✅ | — | ✅ | 中 | バッチ |
| 新しいコメント | 契約書テキストにコメント追加 | ✅ | — | ✅※ | 中 | バッチ |
| 契約書の更新 | 相手が新バージョンをアップロード | ✅ | — | ✅ | 中 | バッチ |

> ※ タイプCの「新しいコメント」：Nego上の交渉コメントのみ通知。Hubble側の社内コメントはHubbleの通知で管理。

#### 交渉中断・再開の通知

| イベント | トリガー | タイプA | タイプB | タイプC | 優先度 | 配信タイミング |
|---------|---------|:------:|:------:|:------:|-------|------------|
| 交渉の中断 | メンバーが交渉を中断した時 | ✅ | ✅ | ✅ | 高 | 即時 |
| 交渉の再開 | メンバーが中断した交渉を再開した時 | ✅ | ✅ | ✅ | 高 | 即時 |

> 中断通知には中断理由が含まれる。再開通知は全メンバーに即時配信される。

#### 署名フェーズの通知

| イベント | トリガー | タイプA | タイプB | タイプC | 優先度 | 配信タイミング |
|---------|---------|:------:|:------:|:------:|-------|------------|
| 署名依頼 | 署名手続き完了後、署名者に送信 | ✅ | ✅ | ✅ | 最高 | 即時 |
| 署名リマインド | 署名依頼後、未署名の署名者へ | ✅ | ✅ | ✅ | 高 | 3日後・7日後 |
| 署名の辞退 | 署名者が署名を辞退した時 | ✅ | — | ✅ | 高 | 即時 |
| 相手が署名完了 | 署名者の一人が署名を完了した時 | ✅ | — | ✅ | 高 | 即時 |
| 全員署名完了（締結） | 全署名者の署名が完了し契約締結 | ✅ | ✅ | ✅ | 最高 | 即時 |

---

### 7.4 タイプB（未サインアップユーザー）の通知設計

まだNegoに登録していないユーザーへの通知は、行動を促す重要な接点となる。

| 通知 | メール内容 | CTA（導線） |
|------|----------|-----------|
| 交渉への招待 | 「○○さんがあなたを契約交渉に招待しています」＋契約書名＋AI要約の抜粋 | 「契約書を確認する →」→ invite.html |
| 署名依頼 | 「○○さんから署名の依頼が届いています」＋契約書名＋期限 | 「署名する →」→ sign.html |
| 署名リマインド | 「署名がまだ完了していません」＋残り期間 | 「署名する →」→ sign.html |
| 全員署名完了（締結） | 「契約が締結されました」＋契約書名 | 「契約書をダウンロード →」→ サインアップへ誘導 |

> **設計意図**: 未登録ユーザーに対しては、通知自体がプロダクトとの最初のタッチポイントになる。メールの時点で「何の契約か」がわかるようにAI要約を含め、安心してアクションできるようにする。

---

### 7.5 タイプC（Hubble連携ユーザー）の通知差分

基本的にタイプAと同じ通知を受け取るが、以下の点で調整する。

| 項目 | 調整内容 |
|------|---------|
| コメント通知 | Nego上の交渉コメントのみ通知。Hubble側の社内コメント通知とは分離 |
| 契約書更新通知 | Negoから相手が更新した場合のみ通知。自社がHubbleから再共有した場合は通知しない（自分のアクションのため） |

---

### 7.6 通知のまとめロジック（バッチウィンドウ方式）

通知疲れを防ぐため、一定条件で通知をまとめる。

| 条件 | まとめる？ | 理由 |
|------|----------|------|
| 同じ人が5分以内に複数アクション | ✅ まとめる | メッセージ連投＋編集などの一連の作業を1通に |
| 違う人のアクション | ❌ 別々に通知 | 誰がアクションしたか明確にするため |
| 署名依頼・署名完了・締結 | ❌ 常に即時通知 | 重要なマイルストーンは例外として即時配信 |

---

### 7.7 通知チャネル

| チャネル | 対応状況 | 備考 |
|---------|---------|------|
| メール | 対応 | 全ての通知の基本チャネル |
| アプリ内通知パネル | 対応 | ログイン中のリアルタイム通知。§7.9を参照 |
| ブラウザ通知 | 将来対応 | ログイン中のプッシュ通知 |
| Slack / Teams連携 | 将来対応 | チーム利用時の通知先として |

---

### 7.8 個人設定（グローバル設定 / settings.html）

ユーザーが通知の受信を制御するための設定。デフォルトで最適な状態にし、変更は任意。

| カテゴリ | 説明 | デフォルト |
|----------|------|-----------|
| 相手からのアクション | 契約書の更新、コメント、メッセージなど、相手方からのアクションがあった時に通知。同一人物の連続アクションは1通にまとめてお届け | 受け取る |
| 署名関連の通知 | 署名依頼、署名完了、契約締結の通知。**常に即時配信・OFFにできない** | 常に受け取る |

> 署名関連の通知は契約の成立に直結するため、ユーザーがOFFにすることはできない。

### 7.9 アプリ内通知パネル

メールだけに依存するとログイン中のユーザーが更新に気づけない。グローバルヘッダーにベルアイコン（🔔）を配置し、アプリ内通知パネルを提供する。

#### パネル仕様

| 項目 | 仕様 |
|------|------|
| 起動方法 | グローバルヘッダーの🔔アイコンをクリック → ドロップダウンパネル表示 |
| 未読バッジ | ベルアイコンの右上に未読件数を赤丸で表示。99件以上は「99+」 |
| 通知リスト | 最新順に表示。各通知はアイコン＋メッセージ＋相対時間（「3分前」「2日前」） |
| 通知アクション | クリックで該当の交渉画面 / 署名画面に遷移 |
| 既読管理 | パネルを開くと表示された通知を自動的に既読。「すべて既読にする」リンクも配置 |
| フィルター | 「すべて」/「未読のみ」のトグル |
| 通知なし状態 | 「通知はありません」＋ベルのイラストを表示 |

#### 表示対象

§7.3 で定義されている全通知イベントのうち、タイプA（Negoユーザー）向けの通知をアプリ内にも表示する。メールとアプリ内通知は同じイベントで同時発行される。

---

## 8. 招待・権限管理

### 8.1 招待方法

| 方法 | 説明 |
|------|------|
| メールアドレス招待 | メールアドレスを入力して招待 |
| リンク共有 | 招待URLをコピーして共有 |

### 8.2 権限タイプ

| 権限 | 説明 |
|------|------|
| メンバー（Member） | 閲覧・編集・コメントが可能 |

> 署名者は交渉への招待とは別に、署名手続き・設定（セクション5.2）で個別に設定する。Negoに招待する時点では権限タイプは1種類（メンバー）のみ。

### 8.3 交渉中のメンバー追加（negotiation.html）

交渉開始後でも、交渉詳細画面のヘッダーにある「メンバー」ボタンからメンバーを追加できる。

| 項目 | 仕様 |
|------|------|
| 起動方法 | ヘッダーの「メンバー」ボタン → メンバーパネル → 「メンバーを追加」ボタン |
| 説明文 | 「招待された方は、契約書の閲覧・編集・コメントができます。署名者は署名手続き・設定で別途指定します。」 |
| 招待方法 | メールアドレス入力 + 招待リンクコピーの2種類（§8.1と同一） |
| 権限選択UI | なし（権限は「メンバー」のみのため、選択肢を設けない） |

### 8.4 招待受領画面（invite.html）

招待リンクを開いた時に表示される画面。サインイン前でも契約の概要を確認できる。

| 項目 | 仕様 |
|------|------|
| 送信者情報 | 招待者のアバター・名前・会社名を表示 |
| AI要約 | 契約の要点サマリーをサインイン前に表示 |
| 契約書プレビュー | 契約書全文をスクロールで閲覧可能 |
| 契約書ダウンロード | Word形式でダウンロード可能（サインイン前でも利用可。社内レビュー用途を想定） |
| サインイン方法 | Google / Microsoft のSSO |
| メリット一覧 | サインイン後にできることを一覧表示 |

### 8.5 招待リンク・署名リンクのライフサイクル

リンクには有効期限と自動無効化ルールを設ける。

#### 招待リンク（交渉への参加用）

| 項目 | 仕様 |
|------|------|
| 有効期限 | 発行から30日間 |
| 自動無効化 | 交渉ステータスが `negotiating` 以外に変わった時点で無効化（`signing_setup_done`, `suspended`, `concluded` への遷移時） |
| 手動無効化 | メンバーパネルの「リンクを無効化して再生成」ボタンで即座に無効化＋新リンク発行 |
| 期限切れ時のUI | invite.html に「このリンクは有効期限が切れました」＋招待者の名前を表示。「招待者に新しいリンクを依頼してください」のガイダンス |
| 署名フェーズで無効化時のUI | invite.html に「この交渉は署名手続きに進みました。参加にはメンバーからの再招待が必要です」と表示 |
| 中断で無効化時のUI | invite.html に「この交渉は中断されています」と表示 |
| 締結で無効化時のUI | invite.html に「この契約は締結済みです」と表示 |
| 再利用 | リンクURLは使い回さない。無効化後は新しいURLを発行 |

#### 署名リンク

| 項目 | 仕様 |
|------|------|
| 有効期限 | 発行から14日間（デフォルト。署名手続き設定で変更可能: 7日 / 14日 / 30日） |
| 自動無効化 | 署名依頼の取り消し（§5.10）時、または交渉が中断（§5.8）された時 |
| 手動無効化 | 署名依頼の取り消し（§5.10）で対応 |
| 期限切れ時のUI | sign.html に「この署名リンクは有効期限が切れました」＋依頼者の名前を表示。「署名依頼の送信者にお問い合わせください」のガイダンス |
| リマインド | 有効期限の3日前・1日前に署名者へリマインドメール |

### 8.6 招待ユーザーの初回セットアップ体験

招待リンク経由で初めてNegoにアクセスするユーザーの体験設計。「呼ばれたから来た人」が最短で交渉に参加できることを最優先する。

#### フロー

```
invite.html（契約プレビュー + AI要約の確認）
  → Google / Microsoft OAuth
    → [新規ユーザーの場合] プロフィール設定画面
    → [既存ユーザーの場合] 交渉画面に直接遷移
```

#### プロフィール設定画面（新規ユーザーのみ）

| 項目 | 仕様 |
|------|------|
| 見出し | 「○○さんとの交渉に参加する準備をしましょう」（招待者の名前を動的に表示） |
| 入力項目 | 氏名（OAuthから自動取得、編集可能）、会社名（任意）、部署・役職（任意） |
| CTAボタン | 「交渉に参加する」（「始める」や「登録」ではなく、目的を明示する文言） |
| 遷移先 | 招待元の交渉画面（negotiation.html）に直接遷移。ダッシュボードは経由しない |
| リダイレクト管理 | OAuthリダイレクト時に招待元の交渉IDをクエリパラメータで保持（`?redirect_negotiation={id}`） |

#### negotiation.html 初回到着時の状態

| 項目 | 仕様 |
|------|------|
| デフォルトタブ | 契約書タブ（AI分析カードが上部に表示されるため、AI要約も契約書本文も同時に視界に入る） |
| ガイダンス方式 | モーダルやツアーは設けない。チャット欄のイベント行（§6.3）とプレースホルダーで文脈を伝える |
| チャット欄イベント | 「○○さんがあなたを招待しました」がイベント行として表示済み |
| チャット入力欄プレースホルダー | 「○○さんにメッセージを送る...」（招待者の名前を動的に表示） |

#### 既存ユーザーが招待された場合

| 項目 | 仕様 |
|------|------|
| OAuth後の遷移先 | プロフィール設定画面をスキップし、交渉画面に直接遷移 |
| ダッシュボードへの反映 | 交渉一覧に新しい交渉が自動追加される |

---

## 9. 交渉詳細画面の共通仕様

Nego単体利用・Hubble連携利用のどちらでも共通する交渉詳細画面（negotiation.html）の仕様。

### 9.1 画面構成

```
┌───────────────────────────────────────────────────────────────────────┐
│ ← 一覧に戻る   業務委託契約書   [メンバー] [Hubble] [署名手続き・設定]│
├───────────────────────────────────────────────────────────────────────┤
│ [概要] [契約書] [関連書類]                                             │
├─────────┬─────────────────────────────────┬──┬──┬──────────────────────┤
│ バージョン │                                 │リ│💬│ パネルヘッダー        │
│ 履歴      │       契約書本文エリア           │サ│🤖│                      │
│           │                                 │イ│  │ チャットタブ          │
│ Ver.8 ◉  │                                 │ズ│  │  メッセージ一覧       │
│ Ver.7    │                                 │ハ│  │  [引用ブロック]       │
│ Ver.6    │                                 │ン│  │  [入力] [送信]        │
│ ...       │                                 │ド│  │                      │
│ Ver.1    │                                 │ル│  │ AIタブ               │
├───────────┤                                 │  │  │  AIチャット          │
│ [Word編集]│                                 │  │  │  [/コマンド] [送信]   │
└───────────┴─────────────────────────────────┴──┴──┴──────────────────────┘
```

- 左右カラム間に**リサイズハンドル**があり、ドラッグで右サイドバーの幅を変更可能
- 右サイドバーは**アイコンタブバー**（💬チャット / 🤖AI）とパネル本体で構成

> **契約書内検索**: MVP では Cmd/Ctrl+F のブラウザネイティブ検索で対応する。Phase 2 で AI チャット（§2.4）に「〜についての条項を探して」と質問する体験を検討する。

### 9.2 タブ構成

交渉詳細画面のメインコンテンツ領域は、**統合ドキュメントタブバー**と**右サイドバー**で構成される。

#### 統合ドキュメントタブバー

メインタブとサブタブを1行に統合したタブバー。左側に契約書類タブ群、区切り線を挟んで右側に関連書類タブを配置する。

```
[基本契約書] [個別契約(案件A)] [+]  |  [関連書類]
```

- 左グループ: 交渉のメイン書類（バージョン管理対象）。書類ごとにタブ切り替え表示。「+」で書類の新規追加が可能
- 区切り線: 書類タブ群と関連書類を視覚的に分離
- 右グループ: 関連書類タブ（補足資料の保管場所、バージョン管理なし）
- デフォルト選択: 最初の書類タブ（基本契約書）

> **旧「概要タブ」の廃止**: AI概要情報（要点サマリー・人モノ金の流れ図・タイムライン）は独立タブではなく、契約書ビュー上部の「AI分析カード」（折りたたみ式）に統合した。概要はドキュメントではなく契約書に対するメタデータであり、契約書を読みながら参照できる配置が適切なため。

#### 契約書ビュー（書類タブ選択時）
- AI分析カード（折りたたみ式、契約書本文の上に配置）
  - やさしい解説（AI生成テキスト）
  - 一般的な同種契約との違い（注目点・標準的な点）
  - 人・モノ・金の流れ図（AI生成フロー図）
  - タイムライン（支払日・更新期限等を時系列表示）
  - 期日アラート
  - 免責文
- バージョン履歴パネル（左サイドバー）
- 契約書本文（中央パネル）
- テキスト選択時のポップアップ（AI解説 / コメント追加）
- コメントアイコン表示

#### 関連書類ビュー

| 項目 | 仕様 |
|------|------|
| 対象 | この交渉に関連する添付書類の一覧（見積書、発注書、請求書、議事録等） |
| 表示形式 | ファイル名＋ファイルタイプアイコン＋アップロード日時＋アップロード者 |
| 対応形式 | Word (.docx, .doc) / PDF / Excel (.xlsx, .xls) / 画像 (png, jpg) |
| ファイルサイズ上限 | 20MB/ファイル |
| 操作 | ダウンロード / 削除（アップロード者 or 交渉メンバーのみ） |
| 追加 | 「+ 追加」ボタンでファイルをアップロード |
| 空の状態 | 「関連書類はまだありません。見積書、発注書、請求書などを追加できます。」 |

#### 右サイドバー（全ビュー共通）
- アイコンタブバー（チャット / AI の2タブ切り替え）
- チャットタブ: メッセージ送受信 + 引用ブロック付きコメント（§3.2）
- AIタブ: AIチャット、ウェルカム画面、クイックアクション、`/`コマンドパレット（§2.4）
- リサイズハンドル: 左右カラム間のドラッグリサイズ

### 9.3 右サイドバー詳細仕様

交渉詳細画面の右カラムに常設されるサイドバー。ドキュメントタブの選択状態に依存せず常に表示される。

#### アイコンタブバー

| 項目 | 仕様 |
|------|------|
| 配置 | サイドバー左端に縦並びで配置（幅40px） |
| タブ数 | 2つ: チャット（`chat`アイコン）/ AI（`smart_toy`アイコン） |
| デフォルト | チャットタブがアクティブ |
| 切替動作 | タブクリックでパネル本体の内容が切り替わる |

#### パネルヘッダー

| 項目 | 仕様 |
|------|------|
| タイトル | チャットタブ:「コメント」/ AIタブ:「AIとチャット」（グラデーション表示） |
| アクションボタン | 新しいスレッド / 履歴 / ヘルプ |

#### チャットタブ

| 項目 | 仕様 |
|------|------|
| メッセージ一覧 | §3.1 メッセージ（チャット）の仕様に準拠 |
| 引用ブロック | §3.2 コメント（引用ブロック方式）の仕様に準拠 |
| 入力欄 | テキストエリア＋送信ボタン |

#### AIタブ

| 項目 | 仕様 |
|------|------|
| AIチャット | §2.4 AIチャットタブの仕様に準拠 |
| ウェルカム画面 | クイックアクション4種のボタンを2x2グリッドで表示 |
| 入力欄 | テキストエリア＋`/`コマンドボタン＋送信ボタン |
| コマンドパレット | `/`入力時に入力欄上部にポップアップ表示。4種のコマンドを選択可能 |

#### リサイズハンドル

| 項目 | 仕様 |
|------|------|
| 配置 | 左カラムと右サイドバーの境界 |
| 操作 | ドラッグで右サイドバーの幅を変更 |
| 幅の制約 | 最小300px、最大は画面幅の55% |
| ビジュアル | ホバー/ドラッグ時にプライマリカラーのラインを表示 |

---

## 10. 非機能要件

### セキュリティ

| 項目 | 要件 |
|------|------|
| 認証 | OAuth 2.0（Google, Microsoft） |
| 通信 | HTTPS必須 |
| データ暗号化 | 保存データの暗号化 |
| アクセス制御 | 招待されたメンバーのみアクセス可能 |

### パフォーマンス

| 項目 | 目標値 |
|------|--------|
| ページロード | 3秒以内 |
| AI解説生成 | 5秒以内 |
| ファイルアップロード | 20MB/30秒以内 |

### 可用性

| 項目 | 目標値 |
|------|--------|
| 稼働率 | 99.9% |
| バックアップ | 日次バックアップ |

### 対応環境

| 項目 | 対応範囲 |
|------|---------|
| ブラウザ | Chrome, Safari, Edge, Firefox（最新2バージョン） |
| デバイス（交渉画面・ダッシュボード） | PC（レスポンシブ対応でタブレットも可）。モバイルは将来対応 |
| デバイス（署名画面 sign.html） | PC + モバイル（モバイルファースト設計。§5.4.1 を参照） |
| デバイス（招待受領 invite.html） | PC + モバイル（契約プレビュー + OAuthの操作が完結する設計） |

### アクセシビリティ（Phase 2）

| 項目 | 要件 |
|------|------|
| 目標 | WCAG 2.1 Level AA 準拠（Phase 2 以降で段階的に達成） |
| キーボード操作 | 全ての主要操作（タブ切替、メッセージ送信、署名実行）がキーボードのみで完結 |
| スクリーンリーダー | 契約書本文、AI要約、チャットメッセージに適切な `aria-label` / `role` を付与 |
| カラーコントラスト | テキストと背景のコントラスト比 4.5:1 以上を確保（デザイントークンで管理） |
| フォーカスインジケーター | フォーカス時に視認可能なアウトラインを表示 |

---

## 11. エラーハンドリング

ユーザーが操作中に遭遇する主要なエラーシナリオとその対応方針。

### 11.1 ファイルアップロードエラー

| エラー | 発生条件 | 表示 | リカバリー |
|--------|---------|------|----------|
| ファイルサイズ超過 | 20MBを超えるファイル | 「ファイルサイズが20MBを超えています。ファイルを圧縮するか、分割してアップロードしてください。」 | アップロードダイアログを維持 |
| 非対応形式 | docx/doc/pdf以外のファイル | 「この形式には対応していません。Word (.docx, .doc) または PDF でアップロードしてください。」 | アップロードダイアログを維持 |
| ネットワークエラー | 通信途中で接続断 | 「アップロードに失敗しました。[再試行]」 | 再試行ボタンで同じファイルを再アップロード |
| 破損ファイル | ファイルの読み取りに失敗 | 「ファイルを読み取れませんでした。ファイルが破損していないか確認してください。」 | アップロードダイアログを維持 |

### 11.2 AI解析エラー

| エラー | 発生条件 | 表示 | リカバリー |
|--------|---------|------|----------|
| AI応答タイムアウト | 10秒以上応答なし | AI生成欄に「生成に時間がかかっています...」→ 20秒で「生成中にエラーが発生しました。[再生成]」 | 再生成ボタン |
| AI解析不能 | 契約書の内容がAIで解析できない（画像PDF等） | 「この書類はAI解析に対応していません。テキストを含むWord/PDFをアップロードしてください。」 | 契約書の閲覧・交渉機能はAI非依存で利用可能 |

### 11.3 同時操作の競合

| エラー | 発生条件 | 表示 | リカバリー |
|--------|---------|------|----------|
| 同時アップロード | 2人が同時に新バージョンをアップロード | 先にアップロードが完了した方を採用。後発者に「別のメンバーがバージョン X をアップロードしました。あなたのファイルもアップロードしますか？」 | 確認後に別バージョンとして保存 |
| 署名中の取り消し | 署名者が署名中に依頼が取り消された | 「署名を確定する」押下時に「この署名依頼は取り消されました」を表示 | 交渉画面へのリンクを表示 |

### 11.4 セッション・認証エラー

| エラー | 発生条件 | 表示 | リカバリー |
|--------|---------|------|----------|
| セッション期限切れ | 長時間操作なし | 「セッションの有効期限が切れました。再度サインインしてください。」 | サインインボタン。サインイン後は元の画面に復帰 |
| OAuth失敗 | Google/Microsoft認証に失敗 | 「認証に失敗しました。もう一度お試しください。別のアカウントでサインインすることもできます。」 | 再認証ボタン |

---

## 12. プラン・利用制限

### 12.1 フリープラン

| 項目 | 制限 |
|------|------|
| 料金 | 無料 |
| 同時進行中の交渉数 | 5件まで（締結済み・中断は含まない） |
| ストレージ | 100MB/アカウント |
| AI解説 | 月10回まで（サマリー自動生成は回数制限なし） |
| 署名 | 月3件まで |
| メンバー | 交渉あたり制限なし |

### 12.2 制限到達時のUI

| 制限 | 表示 | CTA |
|------|------|-----|
| 交渉数上限 | 「＋新しい交渉を始める」ボタンをタップ時に「フリープランでは同時に5件まで交渉できます」 | 「プランを確認する」→ website.html の料金セクション |
| ストレージ上限 | アップロード時に「ストレージの上限に達しました」 | 同上 |
| AI回数上限 | AI操作時に「今月のAI利用回数に達しました。来月1日にリセットされます」 | 同上 |
| 署名上限 | 署名手続き開始時に「今月の署名回数に達しました」 | 同上 |

> **設計思想**: 制限はハードウォール（操作が完全にブロックされる）ではなく、到達時に有料プランへの導線を表示するソフトウォール方式。ただし署名は法的行為のため、上限超過後の署名手続き開始はブロックする。

### 12.3 有料プラン

有料プランの詳細（料金、制限値、追加機能）は website.html の料金セクションで定義。PRD_Common.md ではフリープランの制限のみ管理する。

---

## 13. データ保持・削除ポリシー

| データ種別 | 保持期間 | 削除条件 |
|-----------|---------|---------|
| 契約書ファイル（全バージョン） | 締結後10年間 | 保持期間満了後に自動削除。ユーザーにはエクスポート（§15）を事前通知 |
| 署名記録・監査ログ | 締結後10年間 | 電子署名法の保存義務に準拠 |
| チャットメッセージ・コメント | 締結後10年間 | 契約書と同一ライフサイクル |
| AI生成コンテンツ（サマリー等） | 契約書の保持期間と同一 | 契約書削除時に同時削除 |
| ユーザーアカウント情報 | アカウント削除後30日間 | 30日間の猶予期間中は復元可能。その後完全削除 |
| 中断された交渉 | 中断後1年間 | 1年経過後に自動削除の事前通知を送信。ユーザーが延長操作をしなければ30日後に削除 |

### アカウント削除時の振る舞い

| 項目 | 仕様 |
|------|------|
| 進行中の交渉 | 他のメンバーに通知。交渉自体は削除されない（他メンバーが引き続き利用可能） |
| 締結済み契約の署名記録 | 署名記録は法的有効性を保つため、アカウント削除後も保持 |
| 個人情報 | 名前・メールアドレスは匿名化（「削除済みユーザー」に置換） |

---

## 14. 認証・アカウント設定

### 14.1 認証方式

| 項目 | 仕様 |
|------|------|
| 認証プロバイダー | Google OAuth 2.0 / Microsoft OAuth 2.0 |
| パスワード認証 | 非対応（OAuthのみに統一し、パスワード管理の負担とリスクを排除） |
| セッション | JWT。有効期間は7日間。操作ごとに延長 |

### 14.2 新規ユーザー登録フロー

```
website.html「無料で始める」 or ダッシュボード直接アクセス
  → OAuth プロバイダー選択（Google / Microsoft）
  → OAuth 認証
  → [新規の場合] プロフィール設定画面（氏名確認、会社名・部署・役職を任意入力）
  → ダッシュボード（交渉一覧）に遷移
```

> 招待リンク経由のフローは §8.6 を参照。

### 14.3 ログインフロー

```
ダッシュボード or 任意の画面にアクセス
  → 未認証の場合、ログイン画面にリダイレクト
  → OAuth プロバイダー選択 → 認証
  → 元のURLにリダイレクト（deep link 対応）
```

### 14.4 複数プロバイダーでのアカウント統合

| 項目 | 仕様 |
|------|------|
| 同一メールアドレス | 同じメールアドレスで Google / Microsoft 両方からログインした場合、同一アカウントとして統合 |
| 異なるメールアドレス | 別アカウントとして扱う。統合機能は Phase 2 で検討 |

---

## 15. 交渉記録エクスポート

契約交渉の全記録をユーザーが自社サーバーに保存できるエクスポート機能。

### 15.1 エクスポート形式

| 形式 | 内容 | 用途 |
|------|------|------|
| PDF | 表紙（交渉名、当事者、締結日）＋ 契約書最終版 ＋ AI要約 ＋ チャットログ ＋ コメントログ ＋ 署名証明書 | 社内共有・アーカイブ向け。人が読む用 |
| ZIP | 契約書全バージョン（原本Word/PDF）＋ チャットログ（CSV）＋ コメントログ（CSV）＋ 操作履歴（CSV）＋ 署名証明書（PDF）＋ AI要約（PDF） | システム保存・バックアップ向け |

### 15.2 ブランディング

| 配置箇所 | 表現 |
|---------|------|
| PDF 表紙 | ロゴ＋「契約交渉 powered by Hubble」 |
| PDF 全ページフッター | 「契約交渉 powered by Hubble」（小フォント） |
| CSV / JSONファイル | ブランディングなし |
| ZIP内のREADME.txt | 「この記録は Hubble Nego で生成されました」＋ website.html へのURL |

### 15.3 チャットログの整形

| 項目 | 仕様 |
|------|------|
| PDFのチャット表示 | LINEのトーク履歴書き出しのように読みやすく整形。「名前 HH:MM」＋メッセージ本文 |
| コメント表示 | 「対象テキスト（引用）→ コメント本文 → 返信」の構造で文脈を保持 |
| イベント行 | §6.3 のイベント行も時系列順に含める |

### 15.4 UI導線

| 場所 | 操作 |
|------|------|
| 締結済みビューア（§5.6） | バナーに「記録をダウンロード」ボタンを直接配置 |
| 交渉詳細のヘッダー「...」メニュー | 「交渉記録をエクスポート」（交渉中でも利用可能。その時点までの記録をエクスポート） |
| 設定画面のデータエクスポート | 全交渉の一括エクスポート（ZIP形式のみ） |

### 15.5 権限

| 項目 | 仕様 |
|------|------|
| 個別エクスポート | 交渉メンバー全員が利用可能 |
| 一括エクスポート | アカウントの所有者本人のみ |

---

## 16. 用語集

| 用語 | 定義 |
|------|------|
| 交渉 | 契約書に対する協議・調整の単位 |
| バージョン | 契約書の版数。アップロードごとに自動インクリメント |
| 署名 | 契約内容に同意し、署名を行うこと |
| 締結 | 全署名者の署名が完了し、契約が成立すること |
| メンバー | 交渉に参加している人（自分＋招待した相手） |
| 署名者（Signer） | 署名権限を持つメンバー。署名手続きに参加できる |
| 署名パッケージ | 複数の書類（契約書＋添付書類）をまとめた署名単位 |
| 中断 | 交渉が途中で停止した状態。再開可能 |
| 辞退 | 署名者が署名依頼を断ること。辞退理由の入力が必須 |
| 取り消し | 署名依頼送信者が署名プロセスを巻き戻すこと。交渉は継続可能 |
| 転送 | 署名者が署名義務を別の担当者に委任すること。最大3回まで |
| イベント行 | チャット欄に表示されるシステム操作の記録。メッセージバブルとは視覚的に分離 |
| 監査証跡 | 交渉における全操作の記録。操作者・日時・IPアドレスを含む |
| 署名証明書 | 締結済み契約に対して発行される署名の証明文書。文書ハッシュ値を含む |

---

**Document Version:** 3.0
**Last Updated:** 2026-02-21
